apiVersion: v1
kind: Namespace
metadata:
  name: nfs
---
apiVersion: v1
kind: Pod
metadata:
  namespace: nfs
  name: nfs-server
  labels:
    app: nfs-server
spec:
  nodeSelector:
    local-registry: 'true'
  containers:
    - name: nfs
      image: itsthenetwork/nfs-server-alpine:latest
      securityContext:
        privileged: true
      env:
        - name: SHARED_DIRECTORY
          value: /exports
      volumeMounts:
        - mountPath: /exports
          name: export-volume
  volumes:
    - name: export-volume
      hostPath:
        path: /mnt/nfs-share     # path on the node
        type: DirectoryOrCreate
  #hostNetwork: true
---
apiVersion: v1
kind: Service
metadata:
  namespace: nfs
  name: nfs-server
spec:
  selector:
    app: nfs-server
  clusterIP: None
  ports:
    - name: nfs
      protocol: TCP
      port: 2049
      targetPort: 2049
    - name: nfs-v3-tcp
      protocol: TCP
      port: 111
      targetPort: 111
    - name: nfs-v3-udp
      protocol: UDP
      port: 111
      targetPort: 111
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nfs-server-restrict
  namespace: nfs
spec:
  podSelector:
    matchLabels:
      app: nfs-server
  policyTypes:
    - Ingress
  ingress:
    # Allow NFS (TCP 2049) only from the cluster pod network
    - from:
        - ipBlock:
            cidr: 10.244.0.0/16   # replace with your cluster pod CIDR or allowed IP range
      ports:
        - protocol: TCP
          port: 2049
    # Allow portmapper (TCP 111) for NFSv4 if needed
    - from:
        - ipBlock:
            cidr: 10.244.0.0/16
      ports:
        - protocol: TCP
          port: 111
